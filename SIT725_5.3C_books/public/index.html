<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Books Catalogue</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 24px; }
    h1 { margin-bottom: 8px; }
    .btn { padding: 6px 10px; cursor: pointer; }
    .box { border: 1px solid #ccc; padding: 12px; min-height: 120px; }
    .book-item { padding: 8px; border-bottom: 1px solid #eee; cursor: pointer; }
    .book-item:hover { background: #f7f7f7; }
    .muted { color: #666; }
    .error { color: #b00020; white-space: pre-wrap; }
  </style>
</head>

<body>
  <h1>Books Catalogue developed by s219345761</h1>
  <p>Click the button below to get all book items from the server:</p>

  <button class="btn" id="getAllBtn">Get all books</button>

  <h2>Books</h2>
  <div class="box" id="booksList">
    <span class="muted">No books</span>
  </div>

  <h2>Book details</h2>
  <div class="box" id="bookDetails"></div>

  <script>
    const btn = document.getElementById('getAllBtn');
    const listDiv = document.getElementById('booksList');
    const detailsDiv = document.getElementById('bookDetails');

    function escapeHtml(s) {
      return String(s ?? '')
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }

    // Handles: "29.99", 29.99, { "$numberDecimal": "29.99" }
    function getPriceValue(p) {
      if (p == null) return '';
      if (typeof p === 'string' || typeof p === 'number') return String(p);

      if (typeof p === 'object') {
        if (p['$numberDecimal'] != null) return String(p['$numberDecimal']);
        if (p.numberDecimal != null) return String(p.numberDecimal);
      }
      return '';
    }

    function showError(where, err) {
      const msg = (err && err.message) ? err.message : String(err);
      where.innerHTML = `<div class="error">Error: ${escapeHtml(msg)}</div>`;
    }

    function renderList(items) {
      listDiv.innerHTML = '';

      if (!Array.isArray(items) || items.length === 0) {
        listDiv.innerHTML = `<span class="muted">No books</span>`;
        return;
      }

      items.forEach((b) => {
        const div = document.createElement('div');
        div.className = 'book-item';

        const price = getPriceValue(b.price);
        const currency = b.currency || 'AUD';
        const title = b.title || '(Untitled)';

        div.textContent = `${title} - ${price ? price : 'N/A'} ${currency}`;
        div.addEventListener('click', () => fetchBookById(b.id));
        listDiv.appendChild(div);
      });
    }

    async function fetchJsonWithDebug(url) {
      const res = await fetch(url);

      // Read raw text first so we can show useful errors if JSON parsing fails
      const raw = await res.text();

      if (!res.ok) {
        throw new Error(`HTTP ${res.status} from ${url}\n\n${raw.slice(0, 600)}`);
      }

      try {
        return JSON.parse(raw);
      } catch (e) {
        throw new Error(`Response is not valid JSON from ${url}\n\n${raw.slice(0, 600)}`);
      }
    }

    async function fetchBooks() {
      detailsDiv.textContent = '';
      listDiv.textContent = 'Loading...';

      try {
        const body = await fetchJsonWithDebug('/api/books');

        // Your API format: { statusCode: 200, data: [...] }
        const items = Array.isArray(body) ? body : (Array.isArray(body.data) ? body.data : []);
        renderList(items);
      } catch (err) {
        showError(listDiv, err);
      }
    }

    async function fetchBookById(id) {
      detailsDiv.textContent = 'Loading details...';

      try {
        const body = await fetchJsonWithDebug(`/api/books/${id}`);

        // Your API format likely: { statusCode: 200, data: {...} } OR direct object
        const b = (body && body.data) ? body.data : body;
        if (!b || typeof b !== 'object') {
          detailsDiv.innerHTML = `<span class="muted">Book not found</span>`;
          return;
        }

        const price = getPriceValue(b.price);
        const currency = b.currency || 'AUD';

        detailsDiv.innerHTML = `
          <p><strong>Title:</strong> ${escapeHtml(b.title)}</p>
          <p><strong>Author:</strong> ${escapeHtml(b.author)}</p>
          <p><strong>Year:</strong> ${escapeHtml(b.year)}</p>
          <p><strong>Genre:</strong> ${escapeHtml(b.genre)}</p>
          <p><strong>Summary:</strong> ${escapeHtml(b.summary)}</p>
          <p><strong>Price:</strong> ${escapeHtml(price ? price : 'N/A')} ${escapeHtml(currency)}</p>
        `;
      } catch (err) {
        showError(detailsDiv, err);
      }
    }

    btn.addEventListener('click', fetchBooks);
  </script>
</body>
</html>

